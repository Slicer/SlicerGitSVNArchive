machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  python:
    version: 2.7.11

dependencies:
  cache_directories:
    - "~/docker"

  override:
    - docker info
    - pip install scikit-ci-addons==0.11.0
    - ci_addons docker load-pull-save slicer/slicer-dependencies
    - if [[ -e ~/docker/image-test.tar ]]; then docker load -i ~/docker/image-test.tar; fi
    - docker pull slicer/slicer-test
    - mkdir -p ~/docker; docker save slicer/slicer-test > ~/docker/image-test.tar
    - if [[ -e ~/docker/image-test-opengl.tar ]]; then docker load -i ~/docker/image-test-opengl.tar; fi
    - docker pull slicer/slicer-test:opengl
    - mkdir -p ~/docker; docker save slicer/slicer-test:opengl > ~/docker/image-test-opengl.tar

test:
  override:
    - "echo 'Notice: CircleCI does not build changes to Slicer dependencies' && if git diff --name-only master | grep -q SuperBuild > /dev/null; then echo 'Please create a Pull Request on https://github.com/thewtex/SlicerDocker according to the Update section of the project README.'; false; fi"
    - docker run -e "BUILD_TOOL_FLAGS=-j3" --name slicer -v ~/Slicer:/usr/src/Slicer slicer/slicer-dependencies
    - docker cp slicer:$(docker cp slicer:/usr/src/Slicer-build/Slicer-build/PACKAGE_FILE.txt - | tar xO) $CIRCLE_ARTIFACTS
    - bash ./CMake/CircleCI/run.sh $CIRCLE_SHA1 $CIRCLE_BRANCH
